Minor bug fixes and optimisations
